---
title: Figures for "Assessment of Menstrual Health Status and Evolution through Mobile Apps for Fertility Awareness""
author: "Laura Symul, Katarzyna Wac, Paula Hillard and Marcel SalathÃ©"
date: "2019"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true

---



```{r setup setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


```{r load libraries functions etc, results = FALSE, warnings =FALSE,  eval = TRUE, cache = FALSE}
source("Scripts/libraries.R")
source("Scripts/variables.R")
source("Scripts/functions.R")
```


# User history examples

## History Kindara user

```{r 1A load data}
# TO DO
```

```{r 1A}
# TO DO
```

## History Sympto user

```{r}
source("Scripts/_setup_Sympto.R")
```

```{r 1B load data}
load(file = paste0(IO$restricted_figure_data,"history_sympto.Rdata"), verbose = TRUE)
```

```{r 1B}

plot.tracking.history(d = cycledays_sympto_user_history)
u = unique(cycledays_sympto_user_history$user_id)

pdf(paste0(IO$panels,'1B_history_sympto_example_',u,'.pdf'), useDingbats = FALSE, width = viz$pdf.full.width*0.75, height = viz$pdf.full.width/5)
plot.tracking.history(d = cycledays_sympto_user_history, show_goal = TRUE, relative_date = TRUE)
dev.off()

rm(cycledays_sympto_user_history, u)

```


# Demographics (Fig 2A, S1C)

```{r 2A load data}
#sympto
load(file = paste0(IO$restricted_figure_data,"users_demo_sympto.Rdata"), verbose = TRUE)
# kindara 
load(file = paste0(IO$restricted_figure_data,"users_demo_kindara.Rdata"), verbose = TRUE)

```

## Sympto
```{r demographics table}
summary(users_demo_sympto)
round(apply(users_demo_sympto, 2, sd, na.rm = TRUE), digits = 2)
100 - round(apply(users_demo_sympto, 2, function(x) sum(is.na(x)))/nrow(users_demo_sympto)*100)
```

## Kindara

```{r user_demographics summary of demographics kindara}
round(mean(users_demo_kindara$age_registration, na.rm = TRUE), digits = 1)
round(sd(users_demo_kindara$age_registration, na.rm = TRUE), digits = 1)
round(100 - (sum(is.na(users_demo_kindara$age_registration))/nrow(users_demo_kindara)*100))
```


## Figures 
```{r plot_demographics_histogram}
plot_demographics_histogram = function(x, xlim = c(10, 60), ylim = NA, xlab = "x"){
  par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')
  breaks = min(x, na.rm = TRUE):(max(x, na.rm = TRUE)+1)-0.5
  breaks = round(min(x, na.rm = TRUE)):round((max(x, na.rm = TRUE)+1))-0.5
  h = hist(x, breaks = breaks, plot = FALSE)
  if(any(is.na(ylim))){ylim = c(0,max(h$density)*1.03)}
  plot(h$mids,h$counts/sum(h$counts), type = 'n', axes = FALSE, xlim = xlim, ylim = ylim,yaxs = 'i', xaxs = 'i',
     xlab = xlab, ylab = '% of users', main = '')
  at.x = seq(0,xlim[2]*1.5,by = 10)
  axis(1, col = 'lightgray', col.ticks = 'lightgray')
  at.y = seq(0,max(h$density),by = 0.01)
  while(length(at.y) >= 10){at.y = at.y[rep(c(TRUE,FALSE))]}
  axis(2, at = at.y , labels = 100*at.y, col = 'lightgray', col.ticks = 'lightgray')
  abline(h = at.y, col = 'lightgray')
  abline(v = at.x, col = 'lightgray')
  polygon(c(h$mids,rev(h$mids)), c(h$counts/sum(h$counts),h$counts*0), col = viz_cols$colors_lsy[1], border = NA)
  abline(v = median(x, na.rm = TRUE), lty = 2)
  h = data.frame(x = h$mids, y = h$counts/sum(h$counts))
  return(h)
}
```




```{r 2A age now}

x2 = users_demo_kindara$age_now
h2 = plot_demographics_histogram(x = x2, xlim = c(10, 60), xlab = "Age at time of study")

x = users_demo_sympto$age_now
h = plot_demographics_histogram(x = x, xlim = c(10,60), ylim = c(0,0.08),xlab = 'Age at time of study')
points(h2$x, h2$y, type = "l", col = "mediumseagreen")

pdf.file = paste0(IO$panels,'2_demographics_age_now.pdf')
pdf(pdf.file, width = 3.5, height = 2)
h = plot_demographics_histogram(x = x, xlim = c(10,60), ylim = c(0,0.08),xlab = 'Age at time of study')
points(h2$x, h2$y, type = "l", col = "mediumseagreen")
dev.off()

```


```{r 2A age registration}

x2 = users_demo_kindara$age_registration
h2 = plot_demographics_histogram(x = x2, xlim = c(10, 60), xlab = "Age at registration")

x = users_demo_sympto$age_registration
h = plot_demographics_histogram(x = x, xlim = c(10,60), ylim = c(0,0.08) ,xlab = 'Age at registration')
points(h2$x, h2$y, type = "l", col = "mediumseagreen")

pdf.file = paste0(IO$panels,'2_demographics_age_registration.pdf')
pdf(pdf.file, width = 3.5, height = 2)
h = plot_demographics_histogram(x = x, xlim = c(10,60), ylim = c(0,0.08),xlab = 'Age at registration')
points(h2$x, h2$y, type = "l", col = "mediumseagreen")
abline(v = median(x2, na.rm = TRUE), lty = 4, col = "mediumseagreen" )
dev.off()
```


```{r 2A weight}

x = users_demo_sympto$kg
plot_demographics_histogram(x = x, xlim = c(40,140),xlab = 'Weight (kg)')

pdf.file = paste0(IO$panels,'2_demographics_weight.pdf')
pdf(pdf.file, width = 3.5, height = 2)
x = users_demo_sympto$kg
plot_demographics_histogram(x = x, xlim = c(40,140),xlab = 'Weight (kg)')
dev.off()
```

```{r 2A height}
x = users_demo_sympto$cm
plot_demographics_histogram(x = x, xlim = c(140,190),xlab = 'Height (cm)')

pdf.file = paste0(IO$panels,'2_demographics_height.pdf')
pdf(pdf.file, width = 3.5, height = 2)
plot_demographics_histogram(x = x, xlim = c(140,190),xlab = 'Height (cm)')
dev.off()
```

```{r S1C bmi}
x = users_demo_sympto$bmi
plot_demographics_histogram(x = x, xlim = c(0,50),xlab = 'BMI')

pdf.file = paste0(IO$panels,'S1C_demographics_bmi.pdf')
pdf(pdf.file, width = 3.5, height = 2)
plot_demographics_histogram(x = x, xlim = c(0,50),xlab = 'BMI')
dev.off()
```
```{r clean workspace after demographics}
rm(users_demo_sympto, x, pdf.file)
```


# Tracking frequency

## Kindara


```{r tracking_frequency load Kindara data}

load(paste0(IO$kindara_data_cycles,"03_standard_CYCLES.Rdata"), verbose = TRUE)
CYCLES = CYCLES[(CYCLES$tracking_freq>=0) & (CYCLES$tracking_freq <= 1 ), ]

```


```{r function to extract histogram values from ggplot}
get_hist <- function(p) {
    d <- ggplot_build(p)$data[[1]]
    data.frame(x = d$x, xmin = d$xmin, xmax = d$xmax, y = d$y, group = d$group)
}
```


```{r tracking_frequency tracking frequency with sexual activity kindara}

sex_activity = c("no logged sex","logged sex")

CYCLES$has_logged_sex = factor(sex_activity[(CYCLES$n_sex_tot > 0)+1], levels = sex_activity)

a = aggregate(tracking_freq ~ has_logged_sex, CYCLES, function(x) round(median(x),digits = 2))


g = ggplot(CYCLES, aes(x = tracking_freq, fill = has_logged_sex))+ #coord_flip()+
  geom_histogram(binwidth = 0.025,aes(y = stat(width*density))) +
  geom_vline(data = a, aes(xintercept = tracking_freq, group = has_logged_sex), linetype = 2)+
  geom_text(data = a, aes(x = tracking_freq, y = 0.25, label = tracking_freq , group = has_logged_sex), hjust = -0.5)+
  facet_grid(. ~ has_logged_sex) + 
  expand_limits(x = 0)+
  scale_x_continuous(breaks = seq(0,1,by = 0.2))+
  scale_y_continuous(labels = percent_format()) +
  xlab("Tracking frequency (#day with obs. / cycle length)")+
  ylab("% of cycles")+
  guides(fill = FALSE)+
  theme_light()
g

ggsave(filename = paste0(IO$panels,"2_tracking_frequency_kindara.pdf"),width = 4.5, height = 3)

h_values = get_hist(g)
h_values$group_name = sex_activity[h_values$group]
h_values$tracking_freq = h_values$x
h_values$perc_of_cycles = round(h_values$y * 100, digits = 2)
save(h_values, file = paste0(IO$output_Rdata, "tracking_frequency_kindara.Rdata"))
write.csv(h_values[,c("group_name","tracking_freq","perc_of_cycles")], file = paste0(IO$output_csv, "tracking_frequency_kindara.csv"), row.names = FALSE)

rm(g, sex_activity, h_values, a, CYCLES)
```


## Sympto


```{r}
source("Scripts/_setup_Sympto.R")
```

```{r tracking_frequency load sympto data}
load(paste0(IO$sympto_data_02_standard_cycles,'cycles.Rdata'), verbose = TRUE)
```


```{r tracking_frequency tracking frequency for sympto - save frequency tables}
breaks = seq(0,1,by = 0.025)
N = length(breaks)

par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

for(goal in 1:4){
  for(sex in c(TRUE, FALSE)){
    tfh = plot_tracking_freq(cycles, goal, sex)
    save(tfh, file = paste0(IO$output_Rdata,'tracking_frequency_sympto_',goal,'_',sex,'.Rdata'))
    write.csv(tfh, file = paste0(IO$output_csv,'tracking_frequency_sympto_',goal,'_',sex,'.csv'))
    
    pdf.file = paste0(IO$panels,'2_tracking_frequency_sympto_',goal,'_',sex,'.pdf')
    pdf(pdf.file, width = 4.5, height = 1.5)
    par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')
    plot_tracking_freq(cycles, goal, sex)
    dev.off()
    
  }
}
```

# Observation profiles

## Examples

### Kindara

```{r}
source("Scripts/_setup_Kindara.R")
```


```{r observation profiles examples kindara}
load(paste0(IO$kindara_data_days,"03 selected/day10-11.Rdata"), verbose = TRUE)

cycle_ids = c('c3eeacfe8faf436db8bbc5972c25d208_18','c3eeacfe8faf436db8bbc5972c25d208_19','b4bf193f9ab94acead43a0eb1f6a0dcc_3','d71e51e3114b4b5fb9f7124115c901dd_4')

for(cycle_id in cycle_ids){
  k = which(days$cycle_id == cycle_id)
  plot_cycle(subtable = days[k,], show_temp_time = FALSE, show_weights = TRUE, show_goal = FALSE)
}

cycle_ids = c('c3eeacfe8faf436db8bbc5972c25d208_19')

for(cycle_id in cycle_ids){
  k = which(days$cycle_id == cycle_id)
  pdf(paste0(IO$panels,'3_cycle_example',cycle_id,'.pdf'), 
      useDingbats = FALSE, width = viz$pdf.full.width/1.5, height = viz$pdf.full.width/3)
  plot_cycle(subtable = days[k,], show_temp_time = FALSE, show_weights = TRUE, show_goal = FALSE)
  dev.off()
}
rm(cycle_ids, cycle_id, k, days)
```

### Sympto


```{r}
source("Scripts/_setup_Sympto.R")
```


```{r observation profiles examples sympto load data}
load(paste0(IO$sympto_data_02_standard_cycles,"cycledays.Rdata"), verbose = TRUE)
```


```{r observation profiles examples sympto}

user_id_str = c("S01370x1jgg","S00278x2rao")
cycle_nb = c(5,66)
cycle_ids = paste0(cycledays$user_id[match( user_id_str,cycledays$user_id_str)], "_",cycle_nb)

for(cycle_id in cycle_ids){
  k = which(cycledays$cycle_id == cycle_id)
  plot_cycle(cycledays[k,])
  
  pdf(paste0(IO$panels,'3_cycle_example',cycle_id,'.pdf'), 
      useDingbats = FALSE, width = viz$pdf.full.width/1.5, height = viz$pdf.full.width/3)
  plot_cycle(cycledays[k,])
  dev.off()
}

rm(user_id_str,cycle_nb,cycle_ids, cycle_id, k, cycledays)
```
## Temperature


### Kindara

```{r}
source("Scripts/_setup_Kindara.R")
```

```{r load data temperature kindara}
load(file = paste0(IO$output_Rdata,"delta_BBT_distribution_kindara.Rdata"), verbose = TRUE)
load(file = paste0(IO$output_Rdata,"delta_BBT_summary_kindara.Rdata"), verbose = TRUE)
```



```{r plot Kindara temperature profiles}

mids = as.numeric(colnames(delta_BBT_distribution_kindara[-1]))
cols = paste0('gray',as.numeric(100-round(100*as.matrix(delta_BBT_distribution_kindara[,-1])/max(delta_BBT_distribution_kindara[,-1]))))
cycleday_from_end = delta_BBT_distribution_kindara$cycleday

pdf(file = paste0(IO$panels, "3_temperature_profile_points_end_kindara.pdf"), width = 7, height = 3, useDingbats = FALSE)

par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

plot(rep.col(delta_BBT_distribution_kindara$cycleday, ncol(delta_BBT_distribution_kindara)-1),
     rep.row(mids,nrow(delta_BBT_distribution_kindara)),
     pch = 16,
     col = cols,
     xlab=  'Days from next cycle',
     ylab= expression(paste(Delta,'', T,' from T-pc25 [F] ')),
     axes = FALSE)


axis(1, at = c(-1,seq(-7,-31,by= -7)))
axis(2)
axis(4, at = round(range(delta_BBT_summary_kindara$median),digits = 2))
box()

#10-90
polygon(c(cycleday_from_end,rev(cycleday_from_end)), 
        c(delta_BBT_summary_kindara$p.10, rev(delta_BBT_summary_kindara$p.90)),border = NA, col = rgb(0,0.5,0.8,0.25))
#25-75
polygon(c(cycleday_from_end,rev(cycleday_from_end)), 
        c(delta_BBT_summary_kindara$p.25, rev(delta_BBT_summary_kindara$p.75)),border = NA, col = rgb(0,0.5,0.8,0.35))
# median
points(cycleday_from_end, delta_BBT_summary_kindara$median, type = 'l', lwd = 3, col = rgb(0,0.5,0.8))

segments(x0 = cycleday_from_end[which.min(delta_BBT_summary_kindara$median)], 
         y0 = min(delta_BBT_summary_kindara$median), 
         x1 = 0, y1 =  min(delta_BBT_summary_kindara$median), col = 'gray10', lty = 2)

segments(x0 = cycleday_from_end[which.max(delta_BBT_summary_kindara$median)], 
         y0 = max(delta_BBT_summary_kindara$median), 
         x1 = 0, y1 =  max(delta_BBT_summary_kindara$median), col = 'gray10', lty = 2)
dev.off()


rm(delta_BBT_distribution_kindara, delta_BBT_summary_kindara, mids, cols, cycleday_from_end)

```


![](../Figures Tables Media/Figures/panels/3_temperature_profile_points_end_kindara.pdf){width=100%}


### Sympto


```{r}
source("Scripts/_setup_Sympto.R")
```

```{r load data temperature sympto}
load(file = paste0(IO$output_Rdata,"delta_BBT_distribution_sympto.Rdata"), verbose = TRUE)
load(file = paste0(IO$output_Rdata,"delta_BBT_summary_sympto.Rdata"), verbose = TRUE)
```


```{r plot Sympto temperature profiles}

pdf(file = paste0(IO$panels, "3_temperature_profile_points_end_Sympto.pdf"), width = 7, height = 3, useDingbats = FALSE)

par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

plot(delta_BBT_distribution_sympto$cycleday_from_end, delta_BBT_distribution_sympto$low_norm_temp,
     #xlim = c(-32,-1), 
     ylim = c(-0.2,1),
     xlab=  'Days from next cycle',
     ylab= expression(paste(Delta,'', T^o,' from T - pc25 ')),
     axes = FALSE, type = 'n')

points(delta_BBT_distribution_sympto$cycleday_from_end,delta_BBT_distribution_sympto$low_norm_temp,
       col = rgb(0,0,0,0.7/max(delta_BBT_distribution_sympto$density)*delta_BBT_distribution_sympto$density),cex = 1, pch = 16)

axis(1, at = c(-1,seq(-7,-31,by= -7)))
axis(2)
axis(4, at = round(range(delta_BBT_summary_sympto$median),digits = 2))
box()

#10-90
polygon(c(delta_BBT_summary_sympto$cycleday, rev(delta_BBT_summary_sympto$cycleday)), 
        c(delta_BBT_summary_sympto$p.10, rev(delta_BBT_summary_sympto$p.90)),border = NA, col = rgb(0,0.5,0.8,0.25))
#25-75
polygon(c(delta_BBT_summary_sympto$cycleday,rev(delta_BBT_summary_sympto$cycleday)),
        c(delta_BBT_summary_sympto$p.25, rev(delta_BBT_summary_sympto$p.75)),border = NA, col = rgb(0,0.5,0.8,0.35))
# median
points(delta_BBT_summary_sympto$cycleday, delta_BBT_summary_sympto$median, type = 'l', lwd = 3, col = rgb(0,0.5,0.8))

segments(x0 = delta_BBT_summary_sympto$cycleday[which.min(delta_BBT_summary_sympto$median)], 
         y0 = min(delta_BBT_summary_sympto$median), 
         x1 = 0, y1 =  min(delta_BBT_summary_sympto$median), col = 'gray10', lty = 2)

segments(x0 = delta_BBT_summary_sympto$cycleday[which.max(delta_BBT_summary_sympto$median)], 
         y0 = max(delta_BBT_summary_sympto$median), 
         x1 = 0, y1 =  max(delta_BBT_summary_sympto$median), col = 'gray10', lty = 2)
dev.off()

rm(delta_BBT_distribution_sympto, delta_BBT_summary_sympto)

```

![](../Figures Tables Media/Figures/panels/3_temperature_profile_points_end_Sympto.pdf){width=100%}



### Temperature by orifice (Sympto only)


```{r load Sympto cycledays and cycles data}
load(paste0(IO$sympto_data_02_standard_cycles_with_HMM_res,"cycledays.Rdata"), verbose = TRUE)
load(paste0(IO$sympto_data_02_standard_cycles_with_HMM_res,"cycles.Rdata"), verbose = TRUE)
```

```{r temperature by orifice}

######
# temperature distribution according to orifice

m = match(cycledays$cycle_id, cycles$cycle_id)
cycledays$orifice = cycles$temp_method_txt[m]
orifice = factor(cycledays$orifice, unique(cycledays$orifice))
phase = factor(cycledays$out_phase, levels = c(1,2,4,3))


pdf(file = paste0(IO$panels, "S2_temperature_by_orifice.pdf"), width = 6, height = 3.5, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

b = boxplot(cycledays$temp_c ~ orifice, ylim = c(35.8, 38),
            col = viz_cols$colors_lsy[c(2,4,8,10)], pch = 16, border = viz_cols$colors_lsy_dark[c(2,4,8,10)], cex = 0.5)

dev.off()

pdf(file = paste0(IO$panels, "S2_temperature_by_orifice_and_phase.pdf"), width = 12, height = 3.5, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)


b = boxplot(cycledays$temp_c[orifice != "Undefined"] ~ phase[orifice != "Undefined"]:orifice[orifice != "Undefined"], ylim = c(35.8, 38),
            col = dict$phases$colors[match(levels(phase),dict$phases$index) ], pch = 16, border = 'black', cex = 0.5)

dev.off()

rm(m, orifice, phase, cycledays, cycles)
```




## Bleeding

### Kindara


```{r}
source("Scripts/_setup_Kindara.R")
```

```{r load data bleeding kindara}
load(file = paste0(IO$output_Rdata,"bleeding_distribution_kindara.Rdata"), verbose = TRUE)
```



```{r plot Kindara bleeding profiles}

at.y = seq(0,1,by = 0.25)

pdf(file = paste0(IO$panels, "3_bleeding_profile_kindara.pdf"), width = 8, height = 2, useDingbats = FALSE)

par(las = 1, mar = c(3, 3, 0.25, 3) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

b = barplot(t(as.matrix(bleeding_distribution_kindara[,-1][,c(2:5,1)])), 
            col = dict$bleeding$colors[c(2:5,1)], border = NA, 
            xlab = 'Days in cycle', ylab = '',
            axes = FALSE,ylim = c(0,1),
            names.arg = bleeding_distribution_kindara$cycleday, add = FALSE, plot = TRUE)
axis(2, at = seq(0,1,by = 0.25), labels = seq(0,100,by = 25))
axis(4, at = seq(0,1,by = 0.25), labels = seq(0,100,by = 25))
dev.off()

rm(bleeding_distribution_kindara, at.y, b)

```


![](../Figures Tables Media/Figures/panels/3_bleeding_profile_kindara.pdf){width=100%}


### Sympto

```{r}
source("Scripts/_setup_Sympto.R")
```

```{r load data bleeding sympto}
load(file = paste0(IO$output_Rdata,"bleeding_distribution_sympto.Rdata"), verbose = TRUE)
```


```{r plot Sympto bleeding profiles}

pdf(file = paste0(IO$panels, "3_bleeding_profile_Sympto.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)


b = barplot(t(bleeding_distribution_sympto[,-1]), 
            col = dict$bleeding$colors[2:4], border = NA, 
            xlab = 'Days in cycle', ylab = 'Frequency',
            axes = FALSE,ylim = c(0,1),
            names.arg = bleeding_distribution_sympto$cycleday, add = FALSE, plot = TRUE)

axis(2, at = seq(0,1,by = 0.25))

dev.off()

rm(bleeding_distribution_sympto)


```


![](../Figures Tables Media/Figures/panels/3_bleeding_profile_Sympto.pdf){width=100%}



## Mucus

### Kindara


```{r}
source("Scripts/_setup_Kindara.R")
```

```{r load data mucus kindara}
load(file = paste0(IO$output_Rdata,"cervical_mucus_distribution_kindara.Rdata"), verbose = TRUE)
```



```{r plot Kindara mucus profiles}

at.y = seq(0,1, by = 0.025)

pdf(file = paste0(IO$panels, "3_mucus_profile_end_lines_kindara.pdf"), width = 7, height = 2.5, useDingbats = FALSE)
par(las = 1, mar = c(3, 2.5, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)


matplot(cervical_mucus_distribution_kindara[,-1], type = 'l', 
        col = dict$mucus$colors[which(dict$mucus$index>=0)], 
        lwd = 1.5*dict$mucus$cex[which(dict$mucus$index>=0)],
        lty = dict$mucus$lty[which(dict$mucus$index>=0)],
        xlab = 'Days from next cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.10))


axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(1,22,by = 7),28), labels = c(seq(-28,-7,by=7),1))


dev.off()

rm(cervical_mucus_distribution_kindara, at.y)

```



![](../Figures Tables Media/Figures/panels/3_mucus_profile_end_lines_kindara.pdf){width=100%}



### Sympto

```{r}
source("Scripts/_setup_Sympto.R")
```

```{r load data mucus sympto}
load(file = paste0(IO$output_Rdata,"cervical_mucus_distribution_sympto.Rdata"), verbose = TRUE)
```





```{r plot Sympto mucus profiles}
pdf(file = paste0(IO$panels, "3_mucus_profile_Sympto.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

at.y = seq(0,1,by = 0.25)

matplot(x = cervical_mucus_distribution_sympto$cycleday,
        y = cervical_mucus_distribution_sympto[,-1], 
        type = 'l', lwd = 2, lty = 1,
        col = dict$mucus$colors[match(colnames(cervical_mucus_distribution_sympto[-1]),dict$mucus$hmm.symbols)], 
        xlab = 'Days in cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.5))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))

axis(1, at = c(seq(-28,-7,by = 7),-1))

dev.off()


rm(at.y,cervical_mucus_distribution_sympto)


```


![](../Figures Tables Media/Figures/panels/3_mucus_profile_Sympto.pdf){width=100%}

## Cervix

### Kindara


```{r}
source("Scripts/_setup_Kindara.R")
```

```{r load data cervix kindara}
load(file = paste0(IO$output_Rdata,"cervix_distribution_kindara.Rdata"), verbose = TRUE)
```



```{r plot Kindara cervix profiles}

at.y = seq(0,1,by = 0.005)

# openness

pdf(file = paste0(IO$panels, "S2_cervix_openness_profile_end_lines.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 2.5, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

matplot(cervix_distribution_kindara[,grep("o_",colnames(cervix_distribution_kindara))], type = 'l', lwd = 2, lty = 1,
        col =  c(viz_cols$yellow, viz_cols$light.blue, viz_cols$blue),  
        xlab = 'Days from next cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.025))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(1,22,by = 7),28), labels = c(seq(-28,-7,by=7),1))

dev.off()



# height

pdf(file = paste0(IO$panels, "S2_cervix_height_profile_end_lines.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 2.5, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

matplot(cervix_distribution_kindara[,grep("h_",colnames(cervix_distribution_kindara))], type = 'l', lwd = 2, lty = 1,
        col =  c(viz_cols$yellow, viz_cols$light.blue, viz_cols$blue),  
        xlab = 'Days from next cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.025))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(1,22,by = 7),28), labels = c(seq(-28,-7,by=7),1))

dev.off()


# firmness

pdf(file = paste0(IO$panels, "S2_cervix_firmness_profile_end_lines.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 2.5, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

matplot(cervix_distribution_kindara[,grep("f_",colnames(cervix_distribution_kindara))], type = 'l', lwd = 2, lty = 1,
        col =  c(viz_cols$yellow, viz_cols$light.blue, viz_cols$blue),  
        xlab = 'Days from next cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.025))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(1,22,by = 7),28), labels = c(seq(-28,-7,by=7),1))

dev.off()

rm(cervix_distribution_kindara, at.y)

```


![](../Figures Tables Media/Figures/panels/S2_cervix_openness_profile_end_lines.pdf){width=100%}
![](../Figures Tables Media/Figures/panels/S2_cervix_height_profile_end_lines.pdf){width=100%}
![](../Figures Tables Media/Figures/panels/S2_cervix_firmness_profile_end_lines.pdf){width=100%}



### Sympto

```{r}
source("Scripts/_setup_Sympto.R")
```

```{r load data cervix sympto}
load(file = paste0(IO$output_Rdata,"cervix_distribution_sympto.Rdata"), verbose = TRUE)
```


```{r plot Sympto cervix profiles}

pdf(file = paste0(IO$panels, "S2_cervix_profile_Sympto.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

at.y = seq(0, 1, by = 0.01)

matplot(x = cervix_distribution_sympto$cycleday,
        y = cervix_distribution_sympto[,-1], 
        type = 'l', lwd = 2, lty = 1,
        col = dict$cervix$colors[match(colnames(cervix_distribution_sympto[-1]),dict$cervix$names)], 
        xlab = 'Days in cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.05))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(-28,-7,by = 7),-1))

dev.off()

rm(at.y,cervix_distribution_sympto)


```


![](../Figures Tables Media/Figures/panels/S2_cervix_profile_Sympto.pdf){width=100%}



## Vaginal sensation


### Kindara


```{r}
source("Scripts/_setup_Kindara.R")
```

```{r load data feel kindara}
load(file = paste0(IO$output_Rdata,"vaginal_sensation_distribution_kindara.Rdata"), verbose = TRUE)
```



```{r plot Kindara feel profiles}

at.y = seq(0,1,by = 0.00005)

pdf(file = paste0(IO$panels, "S2_vaginal_sensation_profile_end_lines_kindara.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 3.5, 0.25, 3.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

matplot(vaginal_sensation_distribution_kindara[,-1], type = 'l', lwd = 2, lty = 1,
        col =  c(viz_cols$light.creamy,viz_cols$yellow, viz_cols$light.blue, viz_cols$blue),  
        xlab = 'Days from next cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.0002))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(1,22,by = 7),28), labels = c(seq(-28,-7,by=7),1))

dev.off()

rm(vaginal_sensation_distribution_kindara, at.y)

```


![](../Figures Tables Media/Figures/panels/S2_vaginal_sensation_profile_end_lines_kindara.pdf){width=100%}



### Sympto

```{r}
source("Scripts/_setup_Sympto.R")
```

```{r load data feel sympto}
load(file = paste0(IO$output_Rdata,"vaginal_sensation_distribution_sympto.Rdata"), verbose = TRUE)
```





```{r plot Sympto feel profiles}

pdf(file = paste0(IO$panels, "S2_vaginal_sensation_profile_Sympto.pdf"), width = 7, height = 2, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.8,0.6,0), tcl = -0.4)

at.y = seq(0, 1, by = 0.05)

matplot(x = vaginal_sensation_distribution_sympto$cycleday,
        y = vaginal_sensation_distribution_sympto[,-1], 
        type = 'l', lwd = 2, lty = 1,
        col = dict$cervix$colors[match(colnames(vaginal_sensation_distribution_sympto[-1]),dict$cervix$names)], 
        xlab = 'Days in cycle', ylab = '',
        axes = FALSE,ylim = c(0,0.25))

axis(2, at = at.y, labels = paste0(100*at.y, '%'))
axis(4, at = at.y, labels = paste0(100*at.y, '%'))
axis(1, at = c(seq(-28,-7,by = 7),-1))

dev.off()

rm(at.y,vaginal_sensation_distribution_sympto)

```


![](../Figures Tables Media/Figures/panels/S2_vaginal_sensation_profile_Sympto.pdf){width=100%}





# Ovulation Estimation Results

## Examples

### Kindara

```{r}
source("Scripts/_setup_Kindara.R")
```

```{r ovu_esti kindara examples}

load(paste0(IO$kindara_data_days,'/04 HMM/day10-11.Rdata'), verbose = TRUE)
load(paste0(IO$kindara_data_cycles,'05 standard with ovu est CYCLES.Rdata'), verbose = TRUE)

cycle_ids = c('1497e11dfe844e86b2c84ec11f557af3_4',
              '201790bb7b6b42d89d05e37f656087c4_14',
              '4daf807bfb9e44fc8f75e14291a844a3_30',
              '8067a42a1f894de7b6f04d5fab2b6cc4_9',
              '9a0f0f797020487aa14c75b9d76e6ac1_5',
              'a7a672481c594ed48897caa3ce9fdb46_3',
              'a7be6f1d198d406e8542a3fa6f3e7710_7',
              'bb42baba52d84b458520aaf634c908fa_2',
              'd4dfe0a4ee2948c59ae19f2d0b985a0f_5',
              'd71e51e3114b4b5fb9f7124115c901dd_4',
              'e54d03622e444b3bb5c15813bb9a2bf9_20',
              'eb8ac1b2ffbd448f92f410560df616fb_3',
              'fc38e35706474f87816d4f31c1ff78c8_29'
              )

for(cycle_id in cycle_ids){
  k = which(days$cycle_id == cycle_id)
  plot_fit_results_hmm(cycletable = days[k,], cycles = CYCLES, hmm.res = NA, show_temp_time = FALSE)

  pdf(paste0(IO$panels,'4_kindara_fit_cycle_example_',cycle_id,'.pdf'),
      useDingbats = FALSE, width = viz$pdf.full.width/2, height = 5)
  plot_fit_results_hmm(cycletable = days[k,], cycles = CYCLES, hmm.res = NA, show_temp_time = FALSE)
  dev.off()
}
```



### Sympto


```{r}
source("Scripts/_setup_Sympto.R")
```

```{r ovu_esti sympto examples}

load(paste0(IO$sympto_data_02_standard_cycles_with_HMM_res,'cycledays.Rdata'), verbose = TRUE)
load(paste0(IO$sympto_data_02_standard_cycles_with_HMM_res,'cycles.Rdata'), verbose = TRUE)

cycle_ids = c('514_3','5017_22',"7197_3","990_17","7197_2")

for(cycle_id in cycle_ids){
  cat(cycle_id,"\n")
  j = which(cycledays$cycle_id == cycle_id)
  cycletable = cycledays[j, ]
  N = nrow(cycletable)
  cat(N,"\n")

  res = most_likely_day_of_ovulation_hmm(cycletable = cycletable)
  plot_fit_results_hmm(cycletable = cycletable, hmm.res = res)
  
  pdf(paste0(IO$panels,'4_sympto_fit_cycle_example_',cycle_id,'.pdf'),
      useDingbats = FALSE, width = viz$pdf.full.width/2, height = 5)
  plot_fit_results_hmm(cycletable = cycletable, hmm.res = res)
  dev.off()
}

rm(cycle_id, cycle_ids, j, N, cycletable,res, cycles, cycledays)

```


## Cycle phases duration


```{r cycle_phases_duration kindara load data}
load(file = paste0(IO$output_Rdata, 'cycle_phases_duration_distribution_kindara.Rdata') , verbose = TRUE)
hk = cycle_phases_duration_distribution_kindara
```

```{r cycle_phases_duration sympto load data}
load(file = paste0(IO$output_Rdata, 'cycle_phases_duration_distribution_sympto.Rdata') , verbose = TRUE)
hs = cycle_phases_duration_distribution_sympto
load(paste0(IO$sympto_data_03_reliable_ovulation_estimation,"cycles.Rdata"), verbose = TRUE)
```


```{r cycle_phases_duration figure}

pdf.height = 3
pdf.width = 7

at.y = seq(0,0.22,by = 0.02)
at.x = seq(0,65,by = 7)

# cycle length

pdf(file = paste0(IO$panels, "4_cycle_length_distribution.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$cycle_length, bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Cycle length',ylab = '% of cycles',
              col = 'tomato2', border = 'tomato3', bars = FALSE)

points(x = hk$duration, y = hk$cycle_length, col = 'tomato3', lw = 2, type = "l" )
points(x = hk$duration, y = hk$cycle_length, col = 'tomato3', cex = 0.5, pch = 16, type = "p" )

legend('topright', legend = c('Kindara','Sympto'),
       col = "tomato3", 
       lwd = c(2,1),lty = 1,
       bty = 'o', bg ='white', box.col = 'lightgray' )

dev.off()


pdf(file = paste0(IO$panels, "4_estimated_ovulation_time_distribution.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$ovu, bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Estimated ovulation',ylab = '% of cycles',
              col = 'gray30', border = 'gray25', bars = FALSE)

points(x = hk$duration, y = hk$estimated_ovulation, col = 'gray25', lw = 2, type = "l" )
points(x = hk$duration, y = hk$estimated_ovulation, col = 'gray25', cex = 0.5, pch = 16, type = "p" )
legend('topright', legend = c('Kindara','Sympto'),
       col = "gray25", 
       lwd = c(2,1),lty = 1,
       bty = 'o', bg ='white', box.col = 'lightgray' )

dev.off()

pdf(file = paste0(IO$panels, "4_estimated_luteal_phase_duration_distribution.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$luteal.duration, bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Estimated luteal phase duration',ylab = '% of cycles',
              col = viz_cols$yellow, border = viz_cols$dark.yellow, bars = FALSE)

points(x = hk$duration, y = hk$estimated_luteal_phase, col = viz_cols$dark.yellow, lw = 2, type = "l" )
points(x = hk$duration, y = hk$estimated_luteal_phase, col = viz_cols$dark.yellow, cex = 0.5, pch = 16, type = "p" )
legend('topright', legend = c('Kindara','Sympto'),
       col = viz_cols$dark.yellow, 
       lwd = c(2,1),lty = 1,
       bty = 'o', bg ='white', box.col = 'lightgray' )

dev.off()


rm(pdf.height, pdf.width, at.y, at.x)
```


```{r cycle_phases_duration figure with Sympto reproductive goals}

pdf.height = 3
pdf.width = 7

at.y = seq(0,0.22,by = 0.02)
at.x = seq(0,65,by = 7)

# cycle length

pdf(file = paste0(IO$panels, "4_cycle_length_distribution_sympto_goals.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$cycle_length[cycles$goal_txt == "Conception"], bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Cycle length',ylab = '% of cycles',
              col = 'tomato2', border = 'tomato3', bars = FALSE, plot.median = FALSE)

points(x = hs$duration, y = hs$cycle_length_avoid_preg, col = 'tomato3', lty = 2, type = "l" )
points(x = hs$duration, y = hs$cycle_length_avoid_preg, col = 'tomato3', cex = 0.5, pch = 16, type = "p" )
legend('topright', legend = c('contraception','conception'),
       col = 'tomato3', 
       lwd = 1,lty = c(2,1),
       bty = 'o', bg ='white', box.col = 'lightgray' )
dev.off()


pdf(file = paste0(IO$panels, "4_estimated_ovulation_time_distribution_sympto_goals.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$ovu[cycles$goal_txt == "Conception"], bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Estimated ovulation',ylab = '% of cycles',
              col = 'gray30', border = 'gray25', bars = FALSE)

points(x = hs$duration, y = hs$estimated_ovulation_avoid_preg, col = 'gray25', lty = 2, type = "l" )
points(x = hs$duration, y = hs$estimated_ovulation_avoid_preg, col = 'gray25', cex = 0.5, pch = 16, type = "p" )
legend('topright', legend = c('contraception','conception'),
       col = 'gray25', 
       lwd = 1,lty = c(2,1),
       bty = 'o', bg ='white', box.col = 'lightgray' )

dev.off()

pdf(file = paste0(IO$panels, "4_estimated_luteal_phase_duration_distribution_sympto_goals.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

h = plot_hist(x = cycles$luteal.duration[cycles$goal_txt == "Conception"], bin.size = 1, 
              at.x = seq(0,65,by = 7), at.y = at.y,
              xlab = 'Estimated luteal phase duration',ylab = '% of cycles',
              col = viz_cols$yellow, border = viz_cols$dark.yellow, bars = FALSE)

points(x = hs$duration, y = hs$estimated_luteal_phase_avoid_preg, col = viz_cols$dark.yellow, lty = 2, type = "l" )
points(x = hs$duration, y = hs$estimated_luteal_phase_avoid_preg, col = viz_cols$dark.yellow, cex = 0.5, pch = 16, type = "p" )
legend('topright', legend = c('contraception','conception'),
       col = viz_cols$dark.yellow, 
       lwd = 1,lty = c(2,1),
       bty = 'o', bg ='white', box.col = 'lightgray' )


dev.off()


rm(pdf.height, pdf.width, at.y, at.x)
```


# Estimation parameters: Temperature shift, uncertainty and confidence score

```{r estimation_quality pdf size}
pdf.height = 2
pdf.width = 3.5
```

## Kindara


```{r estimation_quality load kindara data}
load(file = paste0(IO$output_Rdata, 'temperature_shift_distribution_kindara.Rdata'), verbose = TRUE)
DT = temperature_shift_distribution_kindara
load(file = paste0(IO$output_Rdata, 'uncertainties_distribution_kindara.Rdata'), verbose = TRUE)
sd = uncertainties_distribution_kindara
load(file = paste0(IO$output_Rdata, 'confidence_scores_distribution_kindara.Rdata'), verbose = TRUE)
cs = confidence_scores_distribution_kindara
```



```{r estimation_quality figures kindara data DT}

at.x = DT$temperature_shifts
at.y = seq(0,1, by = 0.1)
mids = DT$temperature_shifts
by = mean(diff(mids))

pdf(file = paste0(IO$panels, "S4_DT_distribution_all_kindara.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

f = DT$fraction_of_cycles
N = length(f)
plot(mids,f, type = 'n', 
     axes = FALSE,xlim = range(mids-by/2, mids+by/2), ylim = c(0,0.6),
     yaxs = 'i', xaxs = 'i',
     xlab = 'Temperature shifts [F]', ylab = '% of cycles')
axis(1, at = at.x , col = 'lightgray', col.ticks = 'lightgray', las = 1)
axis(2, at = at.y , labels = 100*at.y, col = 'lightgray', col.ticks = 'lightgray', las = 1)
abline(h = at.y, col = 'lightgray')
abline(v = at.x, col = 'lightgray')
rect(xright =mids-by/2,ybottom = rep(0,N),xleft = mids+by/2, ytop = f,col = 'gray50', border = 'gray40')

f.0 = f; f.0[1] = 0
x.cumsum = cumsum(f.0)
med = mids[which(x.cumsum > (sum(f.0)/2))[1]]
abline(v = med, lty = 2)
text(x = med, y = at.y[2]/3, pos = 4, labels = round(med,digits = 2))

dev.off()

```

```{r estimation_quality figures kindara data sd}
mids = sd$uncertainties
by = mean(diff(mids))
at.x = seq(0,max(mids), by = 1)
at.y = seq(0,1, by = 0.01)


pdf(file = paste0(IO$panels, "S4_uncertainty_distribution_all_kindara.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

f = sd$fraction_of_cycles
N = length(f)
plot(mids,f, type = 'n', 
     axes = FALSE,xlim = range(mids-by/2, mids+by/2), ylim = c(0,0.06),
     yaxs = 'i', xaxs = 'i',
     xlab = 'Uncertainty on ovu. estimation (in days)', ylab = '% of cycles')
axis(1, at = at.x , col = 'lightgray', col.ticks = 'lightgray', las = 1)
axis(2, at = at.y , labels = 100*at.y, col = 'lightgray', col.ticks = 'lightgray', las = 1)
abline(h = at.y, col = 'lightgray')
abline(v = at.x, col = 'lightgray')
rect(xright =mids-by/2,ybottom = rep(0,N),xleft = mids+by/2, ytop = f,col = 'gray50', border = 'gray40')

f.0 = f; f.0[1] = 0
x.cumsum = cumsum(f.0)
med = mids[which(x.cumsum > (sum(f.0)/2))[1]]
abline(v = med, lty = 2)
text(x = med, y = at.y[2]/3, pos = 4, labels = round(med,digits = 2))

dev.off()

```

```{r estimation_quality figures kindara data cs}
mids = cs$confidence_score
by = mean(diff(mids))
at.x = seq(0,max(mids), by = 0.1)
at.y = seq(0,1, by = 0.02)


pdf(file = paste0(IO$panels, "S4_confidence_score_distribution_all_kindara.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

f = cs$fraction_of_cycles
N = length(f)
plot(mids,f, type = 'n', 
     axes = FALSE,xlim = range(mids-by/2, mids+by/2), ylim = c(0,0.16),
     yaxs = 'i', xaxs = 'i',
     xlab = 'Confidence score on ovu. estimates', ylab = '% of cycles')
axis(1, at = at.x , col = 'lightgray', col.ticks = 'lightgray', las = 1)
axis(2, at = at.y , labels = 100*at.y, col = 'lightgray', col.ticks = 'lightgray', las = 1)
abline(h = at.y, col = 'lightgray')
abline(v = at.x, col = 'lightgray')
rect(xright =mids-by/2,ybottom = rep(0,N),xleft = mids+by/2, ytop = f,col = 'gray50', border = 'gray40')

f.0 = f; f.0[1] = 0
x.cumsum = cumsum(f.0)
med = mids[which(x.cumsum > (sum(f.0)/2))[1]]
abline(v = med, lty = 2)
text(x = med, y = at.y[2]/3, pos = 4, labels = round(med,digits = 2))

dev.off()

```

## Sympto



```{r}
source("Scripts/_setup_Sympto.R")
```


```{r estimation_quality pdf size sympto}
pdf.height = 2
pdf.width = 3.5
```


```{r estimation_quality load sympto data}
file = paste0(IO$sympto_data_02_standard_cycles_with_HMM_res,"cycles.Rdata") 
load(file, verbose = TRUE)
```



```{r estimation_quality figures sympto data}

# DELTA T
########################


pdf(file = paste0(IO$panels, "S4_DT_distribution_all_sympto.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

x = cycles$D.T[cycles$D.T >= 0]
h.DT = plot_hist(x = x, bin.size = 0.05, 
          at.x = seq(0,1,by = 0.1), at.y = seq(0,0.25,by = 0.05),
          xlab = 'Temperature shifts',ylab = '% of cycles' )

dev.off()


# SD on OVU ESTIMATION
########################


pdf(file = paste0(IO$panels, "S4_uncertainty_distribution_all_sympto.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

x = cycles$ovu.sd[cycles$ovu.sd >= 0]
h.sd = plot_hist(x = x, bin.size = 0.05, 
          at.x = seq(0,4,by = 0.5), at.y = seq(0,0.1,by = 0.02),
          xlab = 'Uncertainty on ovu. estimates (in days)',ylab = '% of cycles' )

dev.off()

# CONFIDENCE
########################

pdf(file = paste0(IO$panels, "S4_confidence_score_distribution_all_sympto.pdf"), width = pdf.width, height = pdf.height, useDingbats = FALSE)
par(las = 1, mar = c(3, 3, 0.25, 2.5) + 0.1, mgp = c(1.6,0.6,0), tcl = -0.4, col.axis = 'gray60', col.lab = 'gray40')

x = cycles$confidence[cycles$confidence >= 0]
h.c = plot_hist(x = x, bin.size = 0.05, 
          at.x = seq(0,1,by = 0.2), at.y = seq(0,0.4,by = 0.05),
          xlab = 'Confidence score on ovu. estimates',ylab = '% of cycles' )

dev.off()
```

# HMM-state probabilities by cycle length

```{r HMM-state probabilities by cycle length sympto}
source("Scripts/_setup_Sympto.R")

load(file = paste0(IO$output_Rdata, 'states_probabilities_by_cycle_length_sympto.Rdata'), verbose = TRUE)
state_probs_sympto = state_probs

g = ggplot(state_probs, aes(x = cycleday_from_ovu, y = prob, fill = state ))
g = g + geom_area(position = 'identity', alpha = 0.7) + 
  facet_grid(cycle_length_bin ~ ., scales = "free_y") +
  scale_fill_manual(values = hmm_par$cycle.states.colors) +
  xlab("Cycleday from estimated ovulation")+
  ylab("Probabilities * Nb of cycles")

g = g + theme_hc() + 
  theme(strip.text.y = element_text(angle = 0),
        strip.background = element_blank())
g

ggsave(filename = paste0(IO$panels,"S4_states_by_cycle_length_sympto.pdf"), plot = g, height = 5)

```

```{r HMM-state probabilities by cycle length kindara}

source("Scripts/_setup_Kindara.R")

load(file = paste0(IO$output_Rdata, 'states_probabilities_by_cycle_length_sympto.Rdata'), verbose = TRUE)
state_probs_sympto = state_probs

load(file = paste0(IO$output_Rdata, 'states_probabilities_by_cycle_length_kindara.Rdata'), verbose = TRUE)
state_probs_kindara = state_probs

g = ggplot(state_probs, aes(x = cycleday_from_ovu, y = prob, fill = state ))
g = g + geom_area(position = 'identity', alpha = 0.7) + 
  facet_grid(cycle_length_bin ~ ., scales = "free_y") +
  scale_fill_manual(values = hmm_par$cycle.states.colors) +
  xlab("Cycleday from estimated ovulation")+
  ylab("Probabilities * Nb of cycles")

g = g + theme_hc() + 
  theme(strip.text.y = element_text(angle = 0),
        strip.background = element_blank())
g

ggsave(filename = paste0(IO$panels,"S4_states_by_cycle_length_kindara.pdf"), plot = g, height = 5)

```


```{r HMM-state probabilities by cycle length combined}

state_probs  = combine.sum.state.probs(state_probs_kindara, state_probs_sympto)

g = ggplot(state_probs, aes(x = cycleday_from_ovu, y = prob, fill = state ))
g = g + geom_area(position = 'identity', alpha = 0.7) + 
  facet_grid(cycle_length_bin ~ ., scales = "fixed") +
  scale_fill_manual(values = hmm_par$cycle.states.colors) +
  xlab("Cycleday from estimated ovulation")+
  ylab("Probabilities * Nb of cycles")

g = g + theme_hc() + 
  theme(strip.text.y = element_text(angle = 0),
        strip.background = element_blank())
g

ggsave(filename = paste0(IO$panels,"4_states_by_cycle_length_combined.pdf"), plot = g, width = 7, height = 5)

```


# Figure S5 : comparison with previous studies


# Figure S6 : impact of noise and missing data on the estimations



